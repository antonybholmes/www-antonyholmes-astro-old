---
import AuthorPage from "../../components/pages/author-page"
import ContentLayout from "../../layouts/ContentLayout.astro"
import {
  addAuthorHtml,
  getAllAuthors,
  getAuthorMap,
} from "../../lib/api/author"
import {
  addAuthorsToPosts,
  addExcerpts,
  getAllPosts,
  getAuthorPostMap,
  sortPosts,
} from "../../lib/api/post"
import { getPageItems, paginate } from "../../lib/paginate"
import { getUrlFriendlyTag } from "../../lib/tags"
import { getAuthorBaseUrl } from "../../lib/urls"

export async function getStaticPaths() {
  const paths: any[] = []

  const authors = await Promise.all(
    getAllAuthors().map(author => addAuthorHtml(author))
  )

  const authorMap = getAuthorMap()

  const postMap = getAuthorPostMap(
    addAuthorsToPosts(
      await Promise.all(addExcerpts(sortPosts(getAllPosts()))),
      authorMap
    )
  )

  authors.forEach(author => {
    const slug = getUrlFriendlyTag(author.frontmatter.name)
    const posts = postMap[slug]

    paths.push(
      paginate(posts, slug, {
        author,
        root: getAuthorBaseUrl(author.frontmatter.name),
      })
    )
  })

  return paths
}

const { author, data, page, pages } = Astro.props
---

<ContentLayout title={author.frontmatter.name}>
  <AuthorPage
    author={author}
    posts={data}
    page={page}
    pages={pages}
    slot="main"
  />
</ContentLayout>
